ALTER SESSION SET CONTAINER = CDB$ROOT;
ALTER SYSTEM SET ENABLE_GOLDENGATE_REPLICATION=TRUE SCOPE=BOTH;
BEGIN
   EXECUTE IMMEDIATE 'CREATE USER c##dbzuser IDENTIFIED BY dbzpassword CONTAINER=ALL';
EXCEPTION
   WHEN OTHERS THEN IF SQLCODE = -1920 THEN NULL; ELSE RAISE; END IF;
END;
/
GRANT DBA TO c##dbzuser CONTAINER=ALL;
GRANT LOGMINING TO c##dbzuser CONTAINER=ALL;
GRANT EXECUTE ON DBMS_LOGMNR TO c##dbzuser CONTAINER=ALL;
GRANT EXECUTE ON DBMS_LOGMNR_D TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ON V_$LOGMNR_LOGS TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ON V_$LOGMNR_CONTENTS TO c##dbzuser CONTAINER=ALL;
ALTER USER c##dbzuser QUOTA UNLIMITED ON USERS CONTAINER=ALL;
ALTER DATABASE ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;

ALTER SESSION SET CONTAINER = FREEPDB1;

-- Tabela de Entrada (Process Request)
BEGIN
   EXECUTE IMMEDIATE 'CREATE TABLE C##DBZUSER.PROCESS_REQUEST (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EXTERNAL_ID VARCHAR2(100),
    STATUS VARCHAR2(50),
    DESCRIPTION VARCHAR2(255),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CLIENT_TYPE VARCHAR2(50),
    ORIGIN VARCHAR2(50)
)';
EXCEPTION
   WHEN OTHERS THEN IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

-- TABELA TMF621 (Sua nova tabela de saída padronizada)
BEGIN
   EXECUTE IMMEDIATE 'CREATE TABLE C##DBZUSER.TROUBLE_TICKET (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EXTERNAL_ID VARCHAR2(100) NOT NULL,
    DESCRIPTION VARCHAR2(500),
    SEVERITY VARCHAR2(20),
    STATUS VARCHAR2(50),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    RELATED_PARTY_ID VARCHAR2(100),
    TICKET_TYPE VARCHAR2(50)
)';
EXCEPTION
   WHEN OTHERS THEN IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

-- CONFIGURAÇÕES DE CDC E PERMISSÕES (O pulo do gato)
ALTER TABLE C##DBZUSER.PROCESS_REQUEST ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;
ALTER TABLE C##DBZUSER.TROUBLE_TICKET ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;

GRANT SELECT, INSERT, UPDATE, DELETE ON C##DBZUSER.PROCESS_REQUEST TO c##dbzuser;
GRANT SELECT, INSERT, UPDATE, DELETE ON C##DBZUSER.TROUBLE_TICKET TO c##dbzuser;

COMMIT;
EXIT;